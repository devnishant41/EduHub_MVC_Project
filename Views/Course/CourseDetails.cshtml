@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@model Test_EduHub.Models.Combined.CourseMaterialViewModel

@{
    ViewData["Title"] = "Course Details";
}

<div class="container">
    <h1>Course Details</h1>

    @foreach (var course in Model.courseDetailsViewModel)
    {
        <div class="mb-5 p-4 border rounded shadow-sm">
            <h2 class="mb-3">@course.Title</h2>
            <div class="row">
                <div class="col-md-8">
                    <p class="text-muted">@course.Description</p>
                    <p><strong>Level:</strong> @course.Level</p>
                    <p><strong>Category:</strong> @course.CategoryName</p>
                    <p><strong>Dates:</strong> @course.CourseStartDate.ToString("MMM dd, yyyy") -
                        @course.CourseEndDate.ToString("MMM dd, yyyy")</p>
                    <p><strong>Price:</strong> â‚¹@course.Price.ToString("F2")</p>
                    <p><strong>Instructor:</strong> @course.FirstName @course.LastName</p>
                </div>
                <div class="col-md-4">
                    <img src="~/images/courses/course.webp" alt="@course.Title" class="img-fluid rounded mb-3"
                        style="width: 100%; height: auto;">

                    @if (course.UserId == Convert.ToInt32(HttpContextAccessor.HttpContext.Session.GetString("User Id")) &&
                   HttpContextAccessor.HttpContext.Session.GetString("Role") == "Educator")
                    {
                        <div class="d-flex justify-content-end">
                            <a asp-action="EditCourse" asp-controller="Course" asp-route-id="@course.Id"
                                class="btn btn-warning me-2">Edit</a>
                            <a class="btn btn-danger" asp-action="DeleteCourse" asp-controller="Course"
                                asp-route-id="@course.Id">Delete</a>
                        </div>
                    }
                </div>
            </div>

            <h3>
                <a class="btn btn-link" data-toggle="collapse" href="#materials-@course.Id" role="button"
                    aria-expanded="false" aria-controls="materials-@course.Id">
                    View Materials
                </a>
            </h3>
            <div class="collapse" id="materials-@course.Id">
                @{
                    var courseMaterials = Model.Materials.Where(m => m.Courseid == course.Id).ToList();
                }

                @if (courseMaterials.Any())
                {
                    <ul class="list-group">
                        @foreach (var material in courseMaterials)
                        {
                            <li class="list-group-item">
                                <h5>@material.Title</h5>
                                <p>@material.Description</p>
                                <a href="@material.Url" target="_blank">View Material</a>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>No materials available for this course.</p>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var deleteModal = document.getElementById('deleteConfirmationModal');
            deleteModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var courseId = button.getAttribute('data-course-id');
                var confirmDeleteButton = deleteModal.querySelector('#confirmDeleteButton');
                confirmDeleteButton.setAttribute('href', '/Course/DeleteCourseAsync/' + courseId);
            });
        });
    </script>
}